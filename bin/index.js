"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const blobToNodeBuffer = require('blob-to-buffer');
const typedArrayToNodeBuffer = require("typedarray-to-buffer");
exports.isNodeBuffer = require('is-buffer');
exports.nodeBufferToArraybuffer = require('to-arraybuffer');
exports.NodeBuffer = Buffer !== undefined ? Buffer : require('buffer/').Buffer;
/**
 * 序列化标记，标记一个Buffer是object2buffer序列化的结果
 */
exports._serializeMark = exports.NodeBuffer.from('+o2b`');
/**
 * 对数据进行序列化。
 * 二进制数据格式： 元素类型 -> [元素长度] -> 元素内容
 */
function serialize(data) {
    const bufferItems = [exports._serializeMark];
    for (let item of data)
        switch (Object.prototype.toString.call(item)) {
            case '[object Number]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = exports.NodeBuffer.alloc(8);
                type.writeUInt8(0 /* number */, 0);
                content.writeDoubleBE(item, 0);
                bufferItems.push(type, content);
                break;
            }
            case '[object String]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = exports.NodeBuffer.from(item);
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(1 /* string */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            case '[object Boolean]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = exports.NodeBuffer.alloc(1);
                type.writeUInt8(2 /* boolean */, 0);
                content.writeUInt8(item ? 1 : 0, 0);
                bufferItems.push(type, content);
                break;
            }
            case '[object Null]': {
                const type = exports.NodeBuffer.alloc(1);
                type.writeUInt8(3 /* null */, 0);
                bufferItems.push(type);
                break;
            }
            case '[object Undefined]': {
                const type = exports.NodeBuffer.alloc(1);
                type.writeUInt8(4 /* undefined */, 0);
                bufferItems.push(type);
                break;
            }
            case '[object Date]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = exports.NodeBuffer.alloc(8);
                type.writeUInt8(5 /* Date */, 0);
                content.writeDoubleBE(item.getTime(), 0);
                bufferItems.push(type, content);
                break;
            }
            case '[object RegExp]': {
                const type = exports.NodeBuffer.alloc(1);
                const source = item.source; //正则匹配模式 
                const flags = item.flags;
                const sourceContent = exports.NodeBuffer.from(source);
                const sourceContentLength = exports.NodeBuffer.alloc(8);
                const flagsContent = exports.NodeBuffer.from(flags);
                const flagsContentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(6 /* RegExp */, 0);
                sourceContentLength.writeDoubleBE(sourceContent.length, 0);
                flagsContentLength.writeDoubleBE(flagsContent.length, 0);
                bufferItems.push(type, sourceContentLength, sourceContent, flagsContentLength, flagsContent);
                break;
            }
            case '[object Array]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = serialize(item);
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(7 /* Array */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            case '[object Object]': {
                const keys = Object.keys(item);
                const values = keys.map(key => item[key]);
                const type = exports.NodeBuffer.alloc(1);
                const content = serialize([keys, values]);
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(8 /* Object */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            case exports.isNodeBuffer(item): {
                const type = exports.NodeBuffer.alloc(1);
                const content = item;
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(9 /* Buffer */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            case '[object Blob]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = blobToNodeBuffer(item);
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(9 /* Buffer */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            case '[object DataView]': {
                item = item.buffer;
            }
            case '[object ArrayBuffer]':
            case '[object Int8Array]':
            case '[object Int16Array]':
            case '[object Int32Array]':
            case '[object Uint8Array]':
            case '[object Uint8ClampedArray]':
            case '[object Uint16Array]':
            case '[object Uint32Array]':
            case '[object Float32Array]':
            case '[object Float64Array]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = typedArrayToNodeBuffer(item);
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(9 /* Buffer */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            default: {
                const type = exports.NodeBuffer.alloc(1);
                type.writeUInt8(10 /* unknow */, 0);
                bufferItems.push(type);
                break;
            }
        }
    return exports.NodeBuffer.concat(bufferItems);
}
exports.serialize = serialize;
/**
 * 对数据进行反序列化。
 * 注意：传入的Buffer需是使用是object2buffer序列化产生的
 */
function deserialize(data) {
    if (!data.slice(0, exports._serializeMark.length).equals(exports._serializeMark))
        throw new Error('传入的Buffer并不是由object2buffer序列化产生的，无法进行反序列化');
    let previous = 0;
    const result = [];
    while (previous < data.length) {
        const type = data.readUInt8(previous++);
        switch (type) {
            case 0 /* number */: {
                result.push(data.readDoubleBE(previous));
                previous += 8;
                break;
            }
            case 1 /* string */: {
                const length = data.readDoubleBE(previous);
                previous += 8;
                const content = data.slice(previous, previous += length);
                result.push(content.toString());
                break;
            }
            case 2 /* boolean */: {
                const content = data.readUInt8(previous++);
                result.push(content === 1);
                break;
            }
            case 3 /* null */: {
                result.push(null);
                break;
            }
            case 4 /* undefined */: {
                result.push(undefined);
                break;
            }
            case 5 /* Date */: {
                const time = data.readDoubleBE(previous);
                previous += 8;
                result.push(new Date(time));
                break;
            }
            case 6 /* RegExp */: {
                const sourceContentLength = data.readDoubleBE(previous);
                previous += 8;
                const sourceContent = data.slice(previous, previous += length);
                const flagsContentLength = data.readDoubleBE(previous);
                previous += 8;
                const flagsContent = data.slice(previous, previous += length);
                result.push(new RegExp(sourceContent.toString(), flagsContent.toString()));
                break;
            }
            case 7 /* Array */: {
                const length = data.readDoubleBE(previous);
                previous += 8;
                const content = data.slice(previous, previous += length);
                result.push(deserialize(content));
                break;
            }
            case 8 /* Object */: {
                const length = data.readDoubleBE(previous);
                previous += 8;
                const content = data.slice(previous, previous += length);
                const [keys, values] = deserialize(content);
                const obj = {};
                for (var i = 0; i < keys.length; i++) {
                    obj[keys[i]] = values[i];
                }
                result.push(obj);
                break;
            }
            case 9 /* Buffer */: {
                const length = data.readDoubleBE(previous);
                previous += 8;
                result.push(data.slice(previous, previous += length));
                break;
            }
            case 10 /* unknow */: {
                result.push(undefined);
                break;
            }
            default: {
                throw new Error('要被反序列化的数据类型不存在，类型为: ' + type);
            }
        }
    }
    return result;
}
exports.deserialize = deserialize;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO29CQUNuQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixDQUFDO2dCQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2pCLEtBQUssQ0FBQztZQUNWLENBQUM7WUFDRCxxQkFBc0IsQ0FBQztnQkFDbkIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDM0MsUUFBUSxJQUFJLENBQUMsQ0FBQztnQkFFZCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLFFBQVEsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxLQUFLLENBQUM7WUFDVixDQUFDO1lBQ0Qsc0JBQXFCLENBQUM7Z0JBQ2xCLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3ZCLEtBQUssQ0FBQztZQUNWLENBQUM7WUFDRCxTQUFTLENBQUM7Z0JBQ04sTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUNuRCxDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFoR0Qsa0NBZ0dDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGF0YVR5cGUsIERhdGFUeXBlIH0gZnJvbSAnLi9EYXRhVHlwZSc7XHJcbmNvbnN0IGJsb2JUb05vZGVCdWZmZXIgPSByZXF1aXJlKCdibG9iLXRvLWJ1ZmZlcicpO1xyXG5jb25zdCB0eXBlZEFycmF5VG9Ob2RlQnVmZmVyID0gcmVxdWlyZShcInR5cGVkYXJyYXktdG8tYnVmZmVyXCIpO1xyXG5cclxuZXhwb3J0IGNvbnN0IGlzTm9kZUJ1ZmZlcjogKGRhdGE6IEJ1ZmZlcikgPT4gYm9vbGVhbiA9IHJlcXVpcmUoJ2lzLWJ1ZmZlcicpO1xyXG5leHBvcnQgY29uc3Qgbm9kZUJ1ZmZlclRvQXJyYXlidWZmZXI6IChkYXRhOiBCdWZmZXIpID0+IEFycmF5QnVmZmVyID0gcmVxdWlyZSgndG8tYXJyYXlidWZmZXInKTtcclxuZXhwb3J0IGNvbnN0IE5vZGVCdWZmZXI6IHR5cGVvZiBCdWZmZXIgPSBCdWZmZXIgIT09IHVuZGVmaW5lZCA/IEJ1ZmZlciA6IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7XHJcblxyXG4vKipcclxuICog5bqP5YiX5YyW5qCH6K6w77yM5qCH6K6w5LiA5LiqQnVmZmVy5pivb2JqZWN0MmJ1ZmZlcuW6j+WIl+WMlueahOe7k+aenFxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IF9zZXJpYWxpemVNYXJrID0gTm9kZUJ1ZmZlci5mcm9tKCcrbzJiYCcpO1xyXG5cclxuLyoqXHJcbiAqIOWvueaVsOaNrui/m+ihjOW6j+WIl+WMluOAglxyXG4gKiDkuozov5vliLbmlbDmja7moLzlvI/vvJog5YWD57Sg57G75Z6LIC0+IFvlhYPntKDplb/luqZdIC0+IOWFg+e0oOWGheWuuSAgIFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHNlcmlhbGl6ZShkYXRhOiBkYXRhVHlwZVtdKTogQnVmZmVyIHtcclxuICAgIGNvbnN0IGJ1ZmZlckl0ZW1zOiBCdWZmZXJbXSA9IFtfc2VyaWFsaXplTWFya107XHJcblxyXG4gICAgZm9yIChsZXQgaXRlbSBvZiA8YW55PmRhdGEpIHN3aXRjaCAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGl0ZW0pKSB7XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBOdW1iZXJdJzoge1xyXG4gICAgICAgICAgICBjb25zdCB0eXBlID0gTm9kZUJ1ZmZlci5hbGxvYygxKTtcclxuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IE5vZGVCdWZmZXIuYWxsb2MoOCk7XHJcblxyXG4gICAgICAgICAgICB0eXBlLndyaXRlVUludDgoRGF0YVR5cGUubnVtYmVyLCAwKTtcclxuICAgICAgICAgICAgY29udGVudC53cml0ZURvdWJsZUJFKGl0ZW0sIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlLCBjb250ZW50KTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBOb2RlQnVmZmVyLmZyb20oaXRlbSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRMZW5ndGggPSBOb2RlQnVmZmVyLmFsbG9jKDgpO1xyXG5cclxuICAgICAgICAgICAgdHlwZS53cml0ZVVJbnQ4KERhdGFUeXBlLnN0cmluZywgMCk7XHJcbiAgICAgICAgICAgIGNvbnRlbnRMZW5ndGgud3JpdGVEb3VibGVCRShjb250ZW50Lmxlbmd0aCwgMCk7XHJcblxyXG4gICAgICAgICAgICBidWZmZXJJdGVtcy5wdXNoKHR5cGUsIGNvbnRlbnRMZW5ndGgsIGNvbnRlbnQpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBOb2RlQnVmZmVyLmFsbG9jKDEpO1xyXG5cclxuICAgICAgICAgICAgdHlwZS53cml0ZVVJbnQ4KERhdGFUeXBlLmJvb2xlYW4sIDApO1xyXG4gICAgICAgICAgICBjb250ZW50LndyaXRlVUludDgoaXRlbSA/IDEgOiAwLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGJ1ZmZlckl0ZW1zLnB1c2godHlwZSwgY29udGVudCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IE51bGxdJzoge1xyXG4gICAgICAgICAgICBjb25zdCB0eXBlID0gTm9kZUJ1ZmZlci5hbGxvYygxKTtcclxuICAgICAgICAgICAgdHlwZS53cml0ZVVJbnQ4KERhdGFUeXBlLm51bGwsIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgVW5kZWZpbmVkXSc6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS51bmRlZmluZWQsIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgRGF0ZV0nOiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBOb2RlQnVmZmVyLmFsbG9jKDEpO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gTm9kZUJ1ZmZlci5hbGxvYyg4KTtcclxuXHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5EYXRlLCAwKTtcclxuICAgICAgICAgICAgY29udGVudC53cml0ZURvdWJsZUJFKGl0ZW0uZ2V0VGltZSgpLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGJ1ZmZlckl0ZW1zLnB1c2godHlwZSwgY29udGVudCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBOb2RlQnVmZmVyLmFsbG9jKDEpO1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgc291cmNlID0gaXRlbS5zb3VyY2U7IC8v5q2j5YiZ5Yy56YWN5qih5byPIFxyXG4gICAgICAgICAgICBjb25zdCBmbGFncyA9IGl0ZW0uZmxhZ3M7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzb3VyY2VDb250ZW50ID0gTm9kZUJ1ZmZlci5mcm9tKHNvdXJjZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZUNvbnRlbnRMZW5ndGggPSBOb2RlQnVmZmVyLmFsbG9jKDgpO1xyXG4gICAgICAgICAgICBjb25zdCBmbGFnc0NvbnRlbnQgPSBOb2RlQnVmZmVyLmZyb20oZmxhZ3MpO1xyXG4gICAgICAgICAgICBjb25zdCBmbGFnc0NvbnRlbnRMZW5ndGggPSBOb2RlQnVmZmVyLmFsbG9jKDgpO1xyXG5cclxuICAgICAgICAgICAgdHlwZS53cml0ZVVJbnQ4KERhdGFUeXBlLlJlZ0V4cCwgMCk7XHJcbiAgICAgICAgICAgIHNvdXJjZUNvbnRlbnRMZW5ndGgud3JpdGVEb3VibGVCRShzb3VyY2VDb250ZW50Lmxlbmd0aCwgMCk7XHJcbiAgICAgICAgICAgIGZsYWdzQ29udGVudExlbmd0aC53cml0ZURvdWJsZUJFKGZsYWdzQ29udGVudC5sZW5ndGgsIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlLCBzb3VyY2VDb250ZW50TGVuZ3RoLCBzb3VyY2VDb250ZW50LCBmbGFnc0NvbnRlbnRMZW5ndGgsIGZsYWdzQ29udGVudCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IEFycmF5XSc6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBzZXJpYWxpemUoaXRlbSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRMZW5ndGggPSBOb2RlQnVmZmVyLmFsbG9jKDgpO1xyXG5cclxuICAgICAgICAgICAgdHlwZS53cml0ZVVJbnQ4KERhdGFUeXBlLkFycmF5LCAwKTtcclxuICAgICAgICAgICAgY29udGVudExlbmd0aC53cml0ZURvdWJsZUJFKGNvbnRlbnQubGVuZ3RoLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGJ1ZmZlckl0ZW1zLnB1c2godHlwZSwgY29udGVudExlbmd0aCwgY29udGVudCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IE9iamVjdF0nOiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhpdGVtKTtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWVzID0ga2V5cy5tYXAoa2V5ID0+IGl0ZW1ba2V5XSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0eXBlID0gTm9kZUJ1ZmZlci5hbGxvYygxKTtcclxuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHNlcmlhbGl6ZShba2V5cywgdmFsdWVzXSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRMZW5ndGggPSBOb2RlQnVmZmVyLmFsbG9jKDgpO1xyXG5cclxuICAgICAgICAgICAgdHlwZS53cml0ZVVJbnQ4KERhdGFUeXBlLk9iamVjdCwgMCk7XHJcbiAgICAgICAgICAgIGNvbnRlbnRMZW5ndGgud3JpdGVEb3VibGVCRShjb250ZW50Lmxlbmd0aCwgMCk7XHJcblxyXG4gICAgICAgICAgICBidWZmZXJJdGVtcy5wdXNoKHR5cGUsIGNvbnRlbnRMZW5ndGgsIGNvbnRlbnQpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSBpc05vZGVCdWZmZXIoaXRlbSk6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBpdGVtO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50TGVuZ3RoID0gTm9kZUJ1ZmZlci5hbGxvYyg4KTtcclxuXHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5CdWZmZXIsIDApO1xyXG4gICAgICAgICAgICBjb250ZW50TGVuZ3RoLndyaXRlRG91YmxlQkUoY29udGVudC5sZW5ndGgsIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlLCBjb250ZW50TGVuZ3RoLCBjb250ZW50KTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgQmxvYl0nOiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBOb2RlQnVmZmVyLmFsbG9jKDEpO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gYmxvYlRvTm9kZUJ1ZmZlcihpdGVtKTtcclxuICAgICAgICAgICAgY29uc3QgY29udGVudExlbmd0aCA9IE5vZGVCdWZmZXIuYWxsb2MoOCk7XHJcblxyXG4gICAgICAgICAgICB0eXBlLndyaXRlVUludDgoRGF0YVR5cGUuQnVmZmVyLCAwKTtcclxuICAgICAgICAgICAgY29udGVudExlbmd0aC53cml0ZURvdWJsZUJFKGNvbnRlbnQubGVuZ3RoLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGJ1ZmZlckl0ZW1zLnB1c2godHlwZSwgY29udGVudExlbmd0aCwgY29udGVudCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IERhdGFWaWV3XSc6IHtcclxuICAgICAgICAgICAgaXRlbSA9IGl0ZW0uYnVmZmVyO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IEFycmF5QnVmZmVyXSc6XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBJbnQ4QXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IEludDE2QXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IEludDMyQXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IFVpbnQ4QXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XSc6XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBVaW50MTZBcnJheV0nOlxyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgVWludDMyQXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IEZsb2F0MzJBcnJheV0nOlxyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgRmxvYXQ2NEFycmF5XSc6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0eXBlZEFycmF5VG9Ob2RlQnVmZmVyKGl0ZW0pO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50TGVuZ3RoID0gTm9kZUJ1ZmZlci5hbGxvYyg4KTtcclxuXHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5CdWZmZXIsIDApO1xyXG4gICAgICAgICAgICBjb250ZW50TGVuZ3RoLndyaXRlRG91YmxlQkUoY29udGVudC5sZW5ndGgsIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlLCBjb250ZW50TGVuZ3RoLCBjb250ZW50KTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS51bmtub3csIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBOb2RlQnVmZmVyLmNvbmNhdChidWZmZXJJdGVtcyk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlr7nmlbDmja7ov5vooYzlj43luo/liJfljJbjgIIgICBcclxuICog5rOo5oSP77ya5Lyg5YWl55qEQnVmZmVy6ZyA5piv5L2/55So5pivb2JqZWN0MmJ1ZmZlcuW6j+WIl+WMluS6p+eUn+eahFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGRlc2VyaWFsaXplKGRhdGE6IEJ1ZmZlcik6IGRhdGFUeXBlW10ge1xyXG4gICAgaWYgKCFkYXRhLnNsaWNlKDAsIF9zZXJpYWxpemVNYXJrLmxlbmd0aCkuZXF1YWxzKF9zZXJpYWxpemVNYXJrKSlcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+S8oOWFpeeahEJ1ZmZlcuW5tuS4jeaYr+eUsW9iamVjdDJidWZmZXLluo/liJfljJbkuqfnlJ/nmoTvvIzml6Dms5Xov5vooYzlj43luo/liJfljJYnKTtcclxuXHJcbiAgICBsZXQgcHJldmlvdXMgPSAwO1xyXG4gICAgY29uc3QgcmVzdWx0ID0gW107XHJcblxyXG4gICAgd2hpbGUgKHByZXZpb3VzIDwgZGF0YS5sZW5ndGgpIHtcclxuICAgICAgICBjb25zdCB0eXBlID0gZGF0YS5yZWFkVUludDgocHJldmlvdXMrKyk7XHJcblxyXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIERhdGFUeXBlLm51bWJlcjoge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goZGF0YS5yZWFkRG91YmxlQkUocHJldmlvdXMpKTtcclxuICAgICAgICAgICAgICAgIHByZXZpb3VzICs9IDg7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIERhdGFUeXBlLnN0cmluZzoge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZGF0YS5yZWFkRG91YmxlQkUocHJldmlvdXMpO1xyXG4gICAgICAgICAgICAgICAgcHJldmlvdXMgKz0gODtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50ID0gZGF0YS5zbGljZShwcmV2aW91cywgcHJldmlvdXMgKz0gbGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbnRlbnQudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIERhdGFUeXBlLmJvb2xlYW46IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBkYXRhLnJlYWRVSW50OChwcmV2aW91cysrKTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbnRlbnQgPT09IDEpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5udWxsOiB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChudWxsKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgRGF0YVR5cGUudW5kZWZpbmVkOiB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5EYXRlOiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gZGF0YS5yZWFkRG91YmxlQkUocHJldmlvdXMpO1xyXG4gICAgICAgICAgICAgICAgcHJldmlvdXMgKz0gODtcclxuXHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChuZXcgRGF0ZSh0aW1lKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIERhdGFUeXBlLlJlZ0V4cDoge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc291cmNlQ29udGVudExlbmd0aCA9IGRhdGEucmVhZERvdWJsZUJFKHByZXZpb3VzKTtcclxuICAgICAgICAgICAgICAgIHByZXZpb3VzICs9IDg7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzb3VyY2VDb250ZW50ID0gZGF0YS5zbGljZShwcmV2aW91cywgcHJldmlvdXMgKz0gbGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZsYWdzQ29udGVudExlbmd0aCA9IGRhdGEucmVhZERvdWJsZUJFKHByZXZpb3VzKTtcclxuICAgICAgICAgICAgICAgIHByZXZpb3VzICs9IDg7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmbGFnc0NvbnRlbnQgPSBkYXRhLnNsaWNlKHByZXZpb3VzLCBwcmV2aW91cyArPSBsZW5ndGgpO1xyXG5cclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ldyBSZWdFeHAoc291cmNlQ29udGVudC50b1N0cmluZygpLCBmbGFnc0NvbnRlbnQudG9TdHJpbmcoKSkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5BcnJheToge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZGF0YS5yZWFkRG91YmxlQkUocHJldmlvdXMpO1xyXG4gICAgICAgICAgICAgICAgcHJldmlvdXMgKz0gODtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50ID0gZGF0YS5zbGljZShwcmV2aW91cywgcHJldmlvdXMgKz0gbGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGRlc2VyaWFsaXplKGNvbnRlbnQpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgRGF0YVR5cGUuT2JqZWN0OiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsZW5ndGggPSBkYXRhLnJlYWREb3VibGVCRShwcmV2aW91cyk7XHJcbiAgICAgICAgICAgICAgICBwcmV2aW91cyArPSA4O1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBkYXRhLnNsaWNlKHByZXZpb3VzLCBwcmV2aW91cyArPSBsZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgW2tleXMsIHZhbHVlc10gPSBkZXNlcmlhbGl6ZShjb250ZW50KSBhcyBhbnk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgb2JqOiBhbnkgPSB7fTtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIG9ialtrZXlzW2ldXSA9IHZhbHVlc1tpXTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChvYmopO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5CdWZmZXI6IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGRhdGEucmVhZERvdWJsZUJFKHByZXZpb3VzKTtcclxuICAgICAgICAgICAgICAgIHByZXZpb3VzICs9IDg7XHJcblxyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goZGF0YS5zbGljZShwcmV2aW91cywgcHJldmlvdXMgKz0gbGVuZ3RoKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIERhdGFUeXBlLnVua25vdzp7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGVmYXVsdDoge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfopoHooqvlj43luo/liJfljJbnmoTmlbDmja7nsbvlnovkuI3lrZjlnKjvvIznsbvlnovkuLo6ICcgKyB0eXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG59Il19
