"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const typedArrayToNodeBuffer = require("typedarray-to-buffer");
const isNode = require('is-node');
const blob2buffer = require('blob-to-buffer');
/**
 * 将Blob转换为node Buffer
 */
function blobToNodeBuffer(data) {
    return new Promise((resolve, reject) => {
        blob2buffer(data, function (err, buffer) {
            err ? reject(err) : resolve(buffer);
        });
    });
}
exports.blobToNodeBuffer = blobToNodeBuffer;
/**
 * 是不是node Buffer
 */
exports.isNodeBuffer = require('is-buffer');
/**
 * node Buffer转Arraybuffer
 */
exports.nodeBufferToArraybuffer = require('to-arraybuffer');
/**
 * node Buffer
 */
exports.NodeBuffer = isNode ? Buffer : require('buffer/').Buffer;
/**
 * 序列化标记，标记一个Buffer是object2buffer序列化的结果
 */
exports._serializeMark = exports.NodeBuffer.from('+o2b`');
/**
 * 对数据进行序列化。
 * 二进制数据格式： 元素类型 -> [元素长度] -> 元素内容
 */
function serialize(data) {
    const bufferItems = [exports._serializeMark];
    for (let item of data)
        switch (Object.prototype.toString.call(item)) {
            case '[object Number]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = exports.NodeBuffer.alloc(8);
                type.writeUInt8(0 /* number */, 0);
                content.writeDoubleBE(item, 0);
                bufferItems.push(type, content);
                break;
            }
            case '[object String]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = exports.NodeBuffer.from(item);
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(1 /* string */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            case '[object Boolean]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = exports.NodeBuffer.alloc(1);
                type.writeUInt8(2 /* boolean */, 0);
                content.writeUInt8(item ? 1 : 0, 0);
                bufferItems.push(type, content);
                break;
            }
            case '[object Null]': {
                const type = exports.NodeBuffer.alloc(1);
                type.writeUInt8(3 /* null */, 0);
                bufferItems.push(type);
                break;
            }
            case '[object Undefined]': {
                const type = exports.NodeBuffer.alloc(1);
                type.writeUInt8(4 /* undefined */, 0);
                bufferItems.push(type);
                break;
            }
            case '[object Date]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = exports.NodeBuffer.alloc(8);
                type.writeUInt8(5 /* Date */, 0);
                content.writeDoubleBE(item.getTime(), 0);
                bufferItems.push(type, content);
                break;
            }
            case '[object RegExp]': {
                const type = exports.NodeBuffer.alloc(1);
                const source = item.source; //正则匹配模式 
                const flags = item.flags;
                const sourceContent = exports.NodeBuffer.from(source);
                const sourceContentLength = exports.NodeBuffer.alloc(8);
                const flagsContent = exports.NodeBuffer.from(flags);
                const flagsContentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(6 /* RegExp */, 0);
                sourceContentLength.writeDoubleBE(sourceContent.length, 0);
                flagsContentLength.writeDoubleBE(flagsContent.length, 0);
                bufferItems.push(type, sourceContentLength, sourceContent, flagsContentLength, flagsContent);
                break;
            }
            case '[object Array]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = serialize(item);
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(7 /* Array */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            case '[object Object]': {
                const keys = Object.keys(item);
                const values = keys.map(key => item[key]);
                const type = exports.NodeBuffer.alloc(1);
                const content = serialize([keys, values]);
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(8 /* Object */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            case exports.isNodeBuffer(item): {
                const type = exports.NodeBuffer.alloc(1);
                const content = item;
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(9 /* Buffer */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            case '[object DataView]': {
                item = item.buffer;
            }
            case '[object ArrayBuffer]':
            case '[object Int8Array]':
            case '[object Int16Array]':
            case '[object Int32Array]':
            case '[object Uint8Array]':
            case '[object Uint8ClampedArray]':
            case '[object Uint16Array]':
            case '[object Uint32Array]':
            case '[object Float32Array]':
            case '[object Float64Array]': {
                const type = exports.NodeBuffer.alloc(1);
                const content = typedArrayToNodeBuffer(item);
                const contentLength = exports.NodeBuffer.alloc(8);
                type.writeUInt8(9 /* Buffer */, 0);
                contentLength.writeDoubleBE(content.length, 0);
                bufferItems.push(type, contentLength, content);
                break;
            }
            default: {
                const type = exports.NodeBuffer.alloc(1);
                type.writeUInt8(10 /* unknow */, 0);
                bufferItems.push(type);
                break;
            }
        }
    return exports.NodeBuffer.concat(bufferItems);
}
exports.serialize = serialize;
/**
 * 对数据进行反序列化。
 * 注意：传入的Buffer需是使用是object2buffer序列化产生的
 */
function deserialize(data) {
    let previous = 0;
    if (!data.slice(0, previous += exports._serializeMark.length).equals(exports._serializeMark))
        throw new Error('传入的Buffer并不是由object2buffer序列化产生的，无法进行反序列化');
    const result = [];
    while (previous < data.length) {
        const type = data.readUInt8(previous++);
        switch (type) {
            case 0 /* number */: {
                result.push(data.readDoubleBE(previous));
                previous += 8;
                break;
            }
            case 1 /* string */: {
                const length = data.readDoubleBE(previous);
                previous += 8;
                const content = data.slice(previous, previous += length);
                result.push(content.toString());
                break;
            }
            case 2 /* boolean */: {
                const content = data.readUInt8(previous++);
                result.push(content === 1);
                break;
            }
            case 3 /* null */: {
                result.push(null);
                break;
            }
            case 4 /* undefined */: {
                result.push(undefined);
                break;
            }
            case 5 /* Date */: {
                const time = data.readDoubleBE(previous);
                previous += 8;
                result.push(new Date(time));
                break;
            }
            case 6 /* RegExp */: {
                const sourceContentLength = data.readDoubleBE(previous);
                previous += 8;
                const sourceContent = data.slice(previous, previous += sourceContentLength);
                const flagsContentLength = data.readDoubleBE(previous);
                previous += 8;
                const flagsContent = data.slice(previous, previous += flagsContentLength);
                result.push(new RegExp(sourceContent.toString(), flagsContent.toString()));
                break;
            }
            case 7 /* Array */: {
                const length = data.readDoubleBE(previous);
                previous += 8;
                const content = data.slice(previous, previous += length);
                result.push(deserialize(content));
                break;
            }
            case 8 /* Object */: {
                const length = data.readDoubleBE(previous);
                previous += 8;
                const content = data.slice(previous, previous += length);
                const [keys, values] = deserialize(content);
                const obj = {};
                for (var i = 0; i < keys.length; i++) {
                    obj[keys[i]] = values[i];
                }
                result.push(obj);
                break;
            }
            case 9 /* Buffer */: {
                const length = data.readDoubleBE(previous);
                previous += 8;
                result.push(data.slice(previous, previous += length));
                break;
            }
            case 10 /* unknow */: {
                result.push(undefined);
                break;
            }
            default: {
                throw new Error('要被反序列化的数据类型不存在，类型为: ' + type);
            }
        }
    }
    return result;
}
exports.deserialize = deserialize;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO29CQUNuQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixDQUFDO2dCQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2pCLEtBQUssQ0FBQztZQUNWLENBQUM7WUFDRCxxQkFBc0IsQ0FBQztnQkFDbkIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDM0MsUUFBUSxJQUFJLENBQUMsQ0FBQztnQkFFZCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLFFBQVEsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxLQUFLLENBQUM7WUFDVixDQUFDO1lBQ0Qsc0JBQXNCLENBQUM7Z0JBQ25CLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3ZCLEtBQUssQ0FBQztZQUNWLENBQUM7WUFDRCxTQUFTLENBQUM7Z0JBQ04sTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUNuRCxDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFqR0Qsa0NBaUdDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGF0YVR5cGUsIERhdGFUeXBlIH0gZnJvbSAnLi9EYXRhVHlwZSc7XHJcbmNvbnN0IHR5cGVkQXJyYXlUb05vZGVCdWZmZXIgPSByZXF1aXJlKFwidHlwZWRhcnJheS10by1idWZmZXJcIik7XHJcbmNvbnN0IGlzTm9kZSA9IHJlcXVpcmUoJ2lzLW5vZGUnKTtcclxuY29uc3QgYmxvYjJidWZmZXIgPSByZXF1aXJlKCdibG9iLXRvLWJ1ZmZlcicpO1xyXG5cclxuLyoqXHJcbiAqIOWwhkJsb2LovazmjaLkuLpub2RlIEJ1ZmZlclxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGJsb2JUb05vZGVCdWZmZXIoZGF0YTogQmxvYik6IFByb21pc2U8QnVmZmVyPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIGJsb2IyYnVmZmVyKGRhdGEsIGZ1bmN0aW9uIChlcnI6IEVycm9yLCBidWZmZXI6IEJ1ZmZlcikge1xyXG4gICAgICAgICAgICBlcnIgPyByZWplY3QoZXJyKSA6IHJlc29sdmUoYnVmZmVyKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59XHJcblxyXG4vKipcclxuICog5piv5LiN5pivbm9kZSBCdWZmZXJcclxuICovXHJcbmV4cG9ydCBjb25zdCBpc05vZGVCdWZmZXI6IChkYXRhOiBhbnkpID0+IGJvb2xlYW4gPSByZXF1aXJlKCdpcy1idWZmZXInKTtcclxuXHJcbi8qKlxyXG4gKiBub2RlIEJ1ZmZlcui9rEFycmF5YnVmZmVyXHJcbiAqL1xyXG5leHBvcnQgY29uc3Qgbm9kZUJ1ZmZlclRvQXJyYXlidWZmZXI6IChkYXRhOiBCdWZmZXIpID0+IEFycmF5QnVmZmVyID0gcmVxdWlyZSgndG8tYXJyYXlidWZmZXInKTtcclxuXHJcbi8qKlxyXG4gKiBub2RlIEJ1ZmZlclxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IE5vZGVCdWZmZXI6IHR5cGVvZiBCdWZmZXIgPSBpc05vZGUgPyBCdWZmZXIgOiByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyO1xyXG5cclxuLyoqXHJcbiAqIOW6j+WIl+WMluagh+iusO+8jOagh+iusOS4gOS4qkJ1ZmZlcuaYr29iamVjdDJidWZmZXLluo/liJfljJbnmoTnu5PmnpxcclxuICovXHJcbmV4cG9ydCBjb25zdCBfc2VyaWFsaXplTWFyayA9IE5vZGVCdWZmZXIuZnJvbSgnK28yYmAnKTtcclxuXHJcbi8qKlxyXG4gKiDlr7nmlbDmja7ov5vooYzluo/liJfljJbjgIJcclxuICog5LqM6L+b5Yi25pWw5o2u5qC85byP77yaIOWFg+e0oOexu+WeiyAtPiBb5YWD57Sg6ZW/5bqmXSAtPiDlhYPntKDlhoXlrrkgICBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemUoZGF0YTogZGF0YVR5cGVbXSk6IEJ1ZmZlciB7XHJcbiAgICBjb25zdCBidWZmZXJJdGVtczogQnVmZmVyW10gPSBbX3NlcmlhbGl6ZU1hcmtdO1xyXG5cclxuICAgIGZvciAobGV0IGl0ZW0gb2YgPGFueT5kYXRhKSBzd2l0Y2ggKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpdGVtKSkge1xyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBOb2RlQnVmZmVyLmFsbG9jKDgpO1xyXG5cclxuICAgICAgICAgICAgdHlwZS53cml0ZVVJbnQ4KERhdGFUeXBlLm51bWJlciwgMCk7XHJcbiAgICAgICAgICAgIGNvbnRlbnQud3JpdGVEb3VibGVCRShpdGVtLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGJ1ZmZlckl0ZW1zLnB1c2godHlwZSwgY29udGVudCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBOb2RlQnVmZmVyLmFsbG9jKDEpO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gTm9kZUJ1ZmZlci5mcm9tKGl0ZW0pO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50TGVuZ3RoID0gTm9kZUJ1ZmZlci5hbGxvYyg4KTtcclxuXHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5zdHJpbmcsIDApO1xyXG4gICAgICAgICAgICBjb250ZW50TGVuZ3RoLndyaXRlRG91YmxlQkUoY29udGVudC5sZW5ndGgsIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlLCBjb250ZW50TGVuZ3RoLCBjb250ZW50KTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBOb2RlQnVmZmVyLmFsbG9jKDEpO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gTm9kZUJ1ZmZlci5hbGxvYygxKTtcclxuXHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5ib29sZWFuLCAwKTtcclxuICAgICAgICAgICAgY29udGVudC53cml0ZVVJbnQ4KGl0ZW0gPyAxIDogMCwgMCk7XHJcblxyXG4gICAgICAgICAgICBidWZmZXJJdGVtcy5wdXNoKHR5cGUsIGNvbnRlbnQpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBOdWxsXSc6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5udWxsLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGJ1ZmZlckl0ZW1zLnB1c2godHlwZSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IFVuZGVmaW5lZF0nOiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBOb2RlQnVmZmVyLmFsbG9jKDEpO1xyXG4gICAgICAgICAgICB0eXBlLndyaXRlVUludDgoRGF0YVR5cGUudW5kZWZpbmVkLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGJ1ZmZlckl0ZW1zLnB1c2godHlwZSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoge1xyXG4gICAgICAgICAgICBjb25zdCB0eXBlID0gTm9kZUJ1ZmZlci5hbGxvYygxKTtcclxuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IE5vZGVCdWZmZXIuYWxsb2MoOCk7XHJcblxyXG4gICAgICAgICAgICB0eXBlLndyaXRlVUludDgoRGF0YVR5cGUuRGF0ZSwgMCk7XHJcbiAgICAgICAgICAgIGNvbnRlbnQud3JpdGVEb3VibGVCRShpdGVtLmdldFRpbWUoKSwgMCk7XHJcblxyXG4gICAgICAgICAgICBidWZmZXJJdGVtcy5wdXNoKHR5cGUsIGNvbnRlbnQpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoge1xyXG4gICAgICAgICAgICBjb25zdCB0eXBlID0gTm9kZUJ1ZmZlci5hbGxvYygxKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IGl0ZW0uc291cmNlOyAvL+ato+WImeWMuemFjeaooeW8jyBcclxuICAgICAgICAgICAgY29uc3QgZmxhZ3MgPSBpdGVtLmZsYWdzO1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgc291cmNlQ29udGVudCA9IE5vZGVCdWZmZXIuZnJvbShzb3VyY2UpO1xyXG4gICAgICAgICAgICBjb25zdCBzb3VyY2VDb250ZW50TGVuZ3RoID0gTm9kZUJ1ZmZlci5hbGxvYyg4KTtcclxuICAgICAgICAgICAgY29uc3QgZmxhZ3NDb250ZW50ID0gTm9kZUJ1ZmZlci5mcm9tKGZsYWdzKTtcclxuICAgICAgICAgICAgY29uc3QgZmxhZ3NDb250ZW50TGVuZ3RoID0gTm9kZUJ1ZmZlci5hbGxvYyg4KTtcclxuXHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5SZWdFeHAsIDApO1xyXG4gICAgICAgICAgICBzb3VyY2VDb250ZW50TGVuZ3RoLndyaXRlRG91YmxlQkUoc291cmNlQ29udGVudC5sZW5ndGgsIDApO1xyXG4gICAgICAgICAgICBmbGFnc0NvbnRlbnRMZW5ndGgud3JpdGVEb3VibGVCRShmbGFnc0NvbnRlbnQubGVuZ3RoLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGJ1ZmZlckl0ZW1zLnB1c2godHlwZSwgc291cmNlQ29udGVudExlbmd0aCwgc291cmNlQ29udGVudCwgZmxhZ3NDb250ZW50TGVuZ3RoLCBmbGFnc0NvbnRlbnQpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBBcnJheV0nOiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBOb2RlQnVmZmVyLmFsbG9jKDEpO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gc2VyaWFsaXplKGl0ZW0pO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50TGVuZ3RoID0gTm9kZUJ1ZmZlci5hbGxvYyg4KTtcclxuXHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5BcnJheSwgMCk7XHJcbiAgICAgICAgICAgIGNvbnRlbnRMZW5ndGgud3JpdGVEb3VibGVCRShjb250ZW50Lmxlbmd0aCwgMCk7XHJcblxyXG4gICAgICAgICAgICBidWZmZXJJdGVtcy5wdXNoKHR5cGUsIGNvbnRlbnRMZW5ndGgsIGNvbnRlbnQpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBPYmplY3RdJzoge1xyXG4gICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoaXRlbSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlcyA9IGtleXMubWFwKGtleSA9PiBpdGVtW2tleV0pO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBzZXJpYWxpemUoW2tleXMsIHZhbHVlc10pO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50TGVuZ3RoID0gTm9kZUJ1ZmZlci5hbGxvYyg4KTtcclxuXHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5PYmplY3QsIDApO1xyXG4gICAgICAgICAgICBjb250ZW50TGVuZ3RoLndyaXRlRG91YmxlQkUoY29udGVudC5sZW5ndGgsIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlLCBjb250ZW50TGVuZ3RoLCBjb250ZW50KTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgaXNOb2RlQnVmZmVyKGl0ZW0pOiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBOb2RlQnVmZmVyLmFsbG9jKDEpO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gaXRlbTtcclxuICAgICAgICAgICAgY29uc3QgY29udGVudExlbmd0aCA9IE5vZGVCdWZmZXIuYWxsb2MoOCk7XHJcblxyXG4gICAgICAgICAgICB0eXBlLndyaXRlVUludDgoRGF0YVR5cGUuQnVmZmVyLCAwKTtcclxuICAgICAgICAgICAgY29udGVudExlbmd0aC53cml0ZURvdWJsZUJFKGNvbnRlbnQubGVuZ3RoLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGJ1ZmZlckl0ZW1zLnB1c2godHlwZSwgY29udGVudExlbmd0aCwgY29udGVudCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IERhdGFWaWV3XSc6IHtcclxuICAgICAgICAgICAgaXRlbSA9IGl0ZW0uYnVmZmVyO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICdbb2JqZWN0IEFycmF5QnVmZmVyXSc6XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBJbnQ4QXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IEludDE2QXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IEludDMyQXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IFVpbnQ4QXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XSc6XHJcbiAgICAgICAgY2FzZSAnW29iamVjdCBVaW50MTZBcnJheV0nOlxyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgVWludDMyQXJyYXldJzpcclxuICAgICAgICBjYXNlICdbb2JqZWN0IEZsb2F0MzJBcnJheV0nOlxyXG4gICAgICAgIGNhc2UgJ1tvYmplY3QgRmxvYXQ2NEFycmF5XSc6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0eXBlZEFycmF5VG9Ob2RlQnVmZmVyKGl0ZW0pO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50TGVuZ3RoID0gTm9kZUJ1ZmZlci5hbGxvYyg4KTtcclxuXHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS5CdWZmZXIsIDApO1xyXG4gICAgICAgICAgICBjb250ZW50TGVuZ3RoLndyaXRlRG91YmxlQkUoY29udGVudC5sZW5ndGgsIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlLCBjb250ZW50TGVuZ3RoLCBjb250ZW50KTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IE5vZGVCdWZmZXIuYWxsb2MoMSk7XHJcbiAgICAgICAgICAgIHR5cGUud3JpdGVVSW50OChEYXRhVHlwZS51bmtub3csIDApO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVySXRlbXMucHVzaCh0eXBlKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBOb2RlQnVmZmVyLmNvbmNhdChidWZmZXJJdGVtcyk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlr7nmlbDmja7ov5vooYzlj43luo/liJfljJbjgIIgICBcclxuICog5rOo5oSP77ya5Lyg5YWl55qEQnVmZmVy6ZyA5piv5L2/55So5pivb2JqZWN0MmJ1ZmZlcuW6j+WIl+WMluS6p+eUn+eahFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGRlc2VyaWFsaXplKGRhdGE6IEJ1ZmZlcik6IGRhdGFUeXBlW10ge1xyXG4gICAgbGV0IHByZXZpb3VzID0gMDtcclxuXHJcbiAgICBpZiAoIWRhdGEuc2xpY2UoMCwgcHJldmlvdXMgKz0gX3NlcmlhbGl6ZU1hcmsubGVuZ3RoKS5lcXVhbHMoX3NlcmlhbGl6ZU1hcmspKVxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcign5Lyg5YWl55qEQnVmZmVy5bm25LiN5piv55Sxb2JqZWN0MmJ1ZmZlcuW6j+WIl+WMluS6p+eUn+eahO+8jOaXoOazlei/m+ihjOWPjeW6j+WIl+WMlicpO1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG5cclxuICAgIHdoaWxlIChwcmV2aW91cyA8IGRhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgY29uc3QgdHlwZSA9IGRhdGEucmVhZFVJbnQ4KHByZXZpb3VzKyspO1xyXG5cclxuICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5udW1iZXI6IHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGRhdGEucmVhZERvdWJsZUJFKHByZXZpb3VzKSk7XHJcbiAgICAgICAgICAgICAgICBwcmV2aW91cyArPSA4O1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5zdHJpbmc6IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGRhdGEucmVhZERvdWJsZUJFKHByZXZpb3VzKTtcclxuICAgICAgICAgICAgICAgIHByZXZpb3VzICs9IDg7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IGRhdGEuc2xpY2UocHJldmlvdXMsIHByZXZpb3VzICs9IGxlbmd0aCk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb250ZW50LnRvU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5ib29sZWFuOiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50ID0gZGF0YS5yZWFkVUludDgocHJldmlvdXMrKyk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb250ZW50ID09PSAxKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgRGF0YVR5cGUubnVsbDoge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobnVsbCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIERhdGFUeXBlLnVuZGVmaW5lZDoge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godW5kZWZpbmVkKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgRGF0YVR5cGUuRGF0ZToge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IGRhdGEucmVhZERvdWJsZUJFKHByZXZpb3VzKTtcclxuICAgICAgICAgICAgICAgIHByZXZpb3VzICs9IDg7XHJcblxyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3IERhdGUodGltZSkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5SZWdFeHA6IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZUNvbnRlbnRMZW5ndGggPSBkYXRhLnJlYWREb3VibGVCRShwcmV2aW91cyk7XHJcbiAgICAgICAgICAgICAgICBwcmV2aW91cyArPSA4O1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc291cmNlQ29udGVudCA9IGRhdGEuc2xpY2UocHJldmlvdXMsIHByZXZpb3VzICs9IHNvdXJjZUNvbnRlbnRMZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmxhZ3NDb250ZW50TGVuZ3RoID0gZGF0YS5yZWFkRG91YmxlQkUocHJldmlvdXMpO1xyXG4gICAgICAgICAgICAgICAgcHJldmlvdXMgKz0gODtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZsYWdzQ29udGVudCA9IGRhdGEuc2xpY2UocHJldmlvdXMsIHByZXZpb3VzICs9IGZsYWdzQ29udGVudExlbmd0aCk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3IFJlZ0V4cChzb3VyY2VDb250ZW50LnRvU3RyaW5nKCksIGZsYWdzQ29udGVudC50b1N0cmluZygpKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIERhdGFUeXBlLkFycmF5OiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsZW5ndGggPSBkYXRhLnJlYWREb3VibGVCRShwcmV2aW91cyk7XHJcbiAgICAgICAgICAgICAgICBwcmV2aW91cyArPSA4O1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBkYXRhLnNsaWNlKHByZXZpb3VzLCBwcmV2aW91cyArPSBsZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goZGVzZXJpYWxpemUoY29udGVudCkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5PYmplY3Q6IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGRhdGEucmVhZERvdWJsZUJFKHByZXZpb3VzKTtcclxuICAgICAgICAgICAgICAgIHByZXZpb3VzICs9IDg7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IGRhdGEuc2xpY2UocHJldmlvdXMsIHByZXZpb3VzICs9IGxlbmd0aCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBba2V5cywgdmFsdWVzXSA9IGRlc2VyaWFsaXplKGNvbnRlbnQpIGFzIGFueTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBvYmo6IGFueSA9IHt9O1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqW2tleXNbaV1dID0gdmFsdWVzW2ldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG9iaik7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIERhdGFUeXBlLkJ1ZmZlcjoge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZGF0YS5yZWFkRG91YmxlQkUocHJldmlvdXMpO1xyXG4gICAgICAgICAgICAgICAgcHJldmlvdXMgKz0gODtcclxuXHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChkYXRhLnNsaWNlKHByZXZpb3VzLCBwcmV2aW91cyArPSBsZW5ndGgpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgRGF0YVR5cGUudW5rbm93OiB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGVmYXVsdDoge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfopoHooqvlj43luo/liJfljJbnmoTmlbDmja7nsbvlnovkuI3lrZjlnKjvvIznsbvlnovkuLo6ICcgKyB0eXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG59Il19
